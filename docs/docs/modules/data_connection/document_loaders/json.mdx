# JSONLoader.py
import json
from pathlib import Path
from typing import Any, Callable, Dict, List, Optional

import jq

from langchain_community.document_base import Document
from langchain_community.document_loaders.base import DocumentLoader


class JSONLoader(DocumentLoader):
    """Loads documents from JSON files.

    Args:
        file_path (str): Path to the JSON file.
        jq_schema (str): jq query to extract content from JSON.
        content_key (str, optional): Key to extract content from JSON. Defaults to 'content'.
        metadata_func (Callable[[Dict[str, Any], Dict[str, Any]], Dict[str, Any]], optional):
            Function to extract metadata from JSON. Defaults to None.
        is_content_key_jq_parsable (bool, optional): Whether the content_key is compatible with jq schema. Defaults to False.
        json_lines (bool, optional): Whether the JSON data is in JSON Lines format. Defaults to False.
        text_content (bool, optional): Whether to load the content as text. Defaults to True.
    """

    def __init__(
        self,
        file_path: str,
        jq_schema: str,
        content_key: str = "content",
        metadata_func: Optional[Callable[[Dict[str, Any], Dict[str, Any]], Dict[str, Any]]] = None,
        is_content_key_jq_parsable: bool = False,
        json_lines: bool = False,
        text_content: bool = True,
    ):
        self.file_path = file_path
        self.jq_schema = jq_schema
        self.content_key = content_key
        self.metadata_func = metadata_func
        self.is_content_key_jq_parsable = is_content_key_jq_parsable
        self.json_lines = json_lines
        self.text_content = text_content

    def _load(self) -> List[Document]:
        if self.json_lines:
            data = Path(self.file_path).read_text().strip().split("\n")
        else:
            with open(self.file_path, "r") as f:
                data = json.load(f)

        if self.is_content_key_jq_parsable:
            jq_filter = jq.compile(self.jq_schema)
            data = jq_filter(data).all()

        content_key = self.content_key
        if not isinstance(data, list):
            raise ValueError("jq_schema should return a list")

        documents = []
        for record in data:
            if self.text_content:
                page_content = record
                if isinstance(record, dict):
                    page_content = record.get(content_key)

                if page_content is None:
                    raise ValueError(f"Content key '{content_key}' not found in record")
            else:
              
